<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Riesgo Encadenado (CDC Calibrado)</title>
<style>
  :root {
    --bg: #0f0f13;
    --panel: #1b1b22;
    --text: #e0e0e0;
    --accent: #ff4fa3;       /* Rosa neón */
    --accent-dim: #942b5d;
    --success: #00e676;
    --warn: #ffea00;
  }
  * { box-sizing: border-box; }
  body { margin:0; padding:20px; background:var(--bg); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color:var(--text); }
  .wrap { max-width: 1200px; margin:0 auto; }
  h1 { color: #fff; font-weight: 300; margin-bottom: 5px; }
  h1 strong { color: var(--accent); font-weight: 800; }
  .subtitle { font-size: 0.9em; opacity: 0.7; margin-bottom: 25px; display: block; }
  
  .grid { display:grid; grid-template-columns: 380px 1fr; gap:20px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .card { background:var(--panel); border:1px solid #333; border-radius:12px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  
  /* Controles */
  .control-group { margin-bottom: 18px; padding-bottom: 15px; border-bottom: 1px solid #2a2a35; }
  .control-group:last-child { border:0; }
  label { font-size: 13px; color:#aaa; display:block; margin-bottom:8px; }
  .row { display:flex; align-items:center; gap:10px; justify-content: space-between; }
  input[type="range"] { flex:1; accent-color: var(--accent); cursor: pointer; }
  .val { font-family: monospace; font-size: 14px; color: var(--accent); font-weight: bold; min-width: 50px; text-align: right; }
  
  select { background: #252530; border:1px solid #444; color:#fff; padding:6px; border-radius:6px; width:100%; }

  /* Stats */
  .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
  .stat-box { background: #23232d; padding: 15px; border-radius: 8px; text-align: center; border:1px solid #333; }
  .stat-box h3 { margin:0 0 5px; font-size:11px; text-transform:uppercase; letter-spacing:1px; opacity:0.6; }
  .stat-box .num { font-size: 24px; font-weight: 700; color: #fff; }
  .stat-box .sub { font-size: 11px; opacity: 0.5; margin-top: 4px; }

  /* Canvas */
  canvas { width:100%; height: 400px; background: #16161d; border-radius: 8px; border:1px solid #333; }
  
  .note { font-size: 11px; opacity: 0.5; margin-top: 10px; line-height: 1.4; }
  .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold; background:#333; color:#aaa; margin-left:5px; vertical-align: middle;}
</style>
</head>
<body>

<div class="wrap">
  <h1>Riesgo <strong>Encadenado</strong> (Calibrado CDC)</h1>
  <span class="subtitle">Modelo de estado mensual con periodo de eclipse viral y probabilidades reales.</span>

  <div class="grid">
    <div class="card">
      
      <div class="control-group">
        <label>Actos de ÉL con TERCEROS (al mes) <span class="badge">Insertivo (él activo)</span></label>
        <div class="row">
          <input type="range" id="g" min="0" max="30" value="4">
          <span class="val" id="gVal">4</span>
        </div>
      </div>

      <div class="control-group">
        <label>Actos de ÉL CONTIGO (al mes) <span class="badge">Receptivo (tú pasivo)</span></label>
        <div class="row">
          <input type="range" id="c" min="0" max="30" value="2">
          <span class="val" id="cVal">2</span>
        </div>
      </div>

      <div class="control-group">
        <label>Duración simulación (Meses)</label>
        <div class="row">
          <input type="range" id="months" min="1" max="60" value="12">
          <span class="val" id="mVal">12</span>
        </div>
      </div>

      <div class="control-group">
        <label>Probabilidad de que el Tercero sea VIH+ (Prevalencia)</label>
        <div class="row">
          <input type="range" id="pPrevalence" min="0" max="100" value="15" step="1">
          <span class="val" id="pPrevVal">15%</span>
        </div>
        <div class="note">Si no conoces su estado. En apps/zonas de riesgo puede ser 10-20%.</div>
      </div>

      <div class="control-group">
        <label>Uso de Condón (Tercero) - Eficacia: 85%</label>
        <div class="row">
          <input type="range" id="condomUsage" min="0" max="100" value="50" step="5">
          <span class="val" id="condomVal">50%</span>
        </div>
        <label style="margin-top:10px">¿Tu pareja toma PrEP? (Eficacia 99%)</label>
        <select id="prep">
          <option value="0">No usa PrEP</option>
          <option value="1">Sí usa PrEP (Diario/A demanda)</option>
        </select>
      </div>

      <div class="control-group">
        <label>Dinámica de la Infección</label>
        <div class="row" style="margin-bottom:8px">
          <span style="font-size:12px; opacity:0.8">Orden de actos:</span>
          <select id="order" style="width:140px">
            <option value="random">Aleatorio</option>
            <option value="worst">Peor (Él primero)</option>
          </select>
        </div>
        <div class="row">
           <span style="font-size:12px; opacity:0.8">Fase Aguda (×12 viralidad):</span>
           <input type="checkbox" id="acuteRisk" checked>
        </div>
        <div class="note">Si él se infecta, su carga viral se dispara los primeros 2 meses, aumentando el riesgo de pasártelo.</div>
      </div>

      <div class="stats">
        <div class="stat-box">
          <h3>Prob. Mensual</h3>
          <div class="num" id="resMonth">0%</div>
          <div class="sub" id="resMonthN">-</div>
        </div>
        <div class="stat-box">
          <h3>Prob. Acumulada</h3>
          <div class="num" style="color:var(--accent)" id="resTotal">0%</div>
          <div class="sub" id="resTotalN">-</div>
        </div>
        <div class="stat-box">
          <h3>Equiv. Moneda</h3>
          <div class="num" id="resCoin">-</div>
          <div class="sub">Caras seguidas</div>
        </div>
      </div>

    </div>

    <div class="card">
      <canvas id="mainChart"></canvas>
      <div class="note" style="margin-top:15px">
        <strong>Base científica (CDC):</strong>
        <ul>
          <li>Riesgo Insertivo (Él con 3º): ~0.11% por acto (11/10,000).</li>
          <li>Riesgo Receptivo (Tú con Él): ~1.38% por acto (138/10,000).</li>
          <li>Periodo de Eclipse: Si él se infecta, tarda ~10 días en ser contagioso.</li>
          <li>Fase Aguda: Multiplicador ×11.9 durante los primeros 2 meses post-eclipse.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * FUENTES DE DATOS:
 * 1. CDC (Centers for Disease Control and Prevention), "HIV Risk Behaviors", 2023 update.
 * - Receptivo Anal: 1.38%
 * - Insertivo Anal: 0.11%
 * 2. Hollingsworth TD et al. (2008) / Wawer et al. (2005):
 * - Infectividad fase aguda vs crónica: 10x - 26x. Usaremos media conservadora ~12x.
 * 3. Eficacia Condón:
 * - Cochrane Review: ~80-90% reducción riesgo. Usamos 0.85 como media MSM.
 * 4. Eficacia PrEP:
 * - CDC/iPrEx: >99% reducción riesgo de adquisición.
 */

const CONSTANTS = {
  RISK_INSERTIVE: 0.0011, // Él adquiriendo del tercero
  RISK_RECEPTIVE: 0.0138, // Él transmitiendo a ti
  ACUTE_MULTIPLIER: 11.9, // Multiplicador de riesgo en fase aguda
  CONDOM_EFFICACY: 0.85,  
  PREP_EFFICACY: 0.99,
  ECLIPSE_FRACTION: 0.33  // ~10 días de 30. Fracción del mes donde NO es contagioso aún si se infecta ese mes.
};

const ui = {
  g: document.getElementById('g'),
  c: document.getElementById('c'),
  m: document.getElementById('months'),
  prev: document.getElementById('pPrevalence'),
  condom: document.getElementById('condomUsage'),
  prep: document.getElementById('prep'),
  order: document.getElementById('order'),
  acute: document.getElementById('acuteRisk'),
  // labels
  gVal: document.getElementById('gVal'),
  cVal: document.getElementById('cVal'),
  mVal: document.getElementById('mVal'),
  pPrevVal: document.getElementById('pPrevVal'),
  condomVal: document.getElementById('condomVal'),
  // results
  rMonth: document.getElementById('resMonth'),
  rMonthN: document.getElementById('resMonthN'),
  rTotal: document.getElementById('resTotal'),
  rTotalN: document.getElementById('resTotalN'),
  rCoin: document.getElementById('resCoin'),
};

const ctx = document.getElementById('mainChart').getContext('2d');
let chartObj = null;

// Helpers matemáticos
const probAtLeastOne = (p, n) => 1 - Math.pow(1 - p, n);
const applyReduction = (baseP, reduction) => baseP * (1 - reduction);

// Formateo
const fmtPct = (n) => (n*100).toFixed(n < 0.001 ? 4 : 2) + '%';
const fmtOneIn = (n) => n > 0 ? '1 en ' + Math.round(1/n).toLocaleString() : '-';

function calculate() {
  const actsThird = parseInt(ui.g.value);
  const actsYou = parseInt(ui.c.value);
  const months = parseInt(ui.m.value);
  const prevalence = parseInt(ui.prev.value) / 100;
  const condomFreq = parseInt(ui.condom.value) / 100;
  const hasPrep = ui.prep.value === "1";
  const useAcute = ui.acute.checked;
  const orderMode = ui.order.value; // 'random' or 'worst'

  // 1. Calcular riesgo de que ÉL adquiera VIH del TERCERO en UN acto
  // Riesgo base insertivo
  let rAcqBase = CONSTANTS.RISK_INSERTIVE;
  
  // Ajuste por condón (promedio ponderado)
  // P(transmision) = P(sin_condon)*Freq_sin + P(con_condon)*Freq_con
  let rAcqNoCondom = rAcqBase; 
  let rAcqCondom = rAcqBase * (1 - CONSTANTS.CONDOM_EFFICACY);
  let rAcqAvg = (rAcqNoCondom * (1 - condomFreq)) + (rAcqCondom * condomFreq);

  // Ajuste por PrEP (si él la toma)
  if (hasPrep) rAcqAvg *= (1 - CONSTANTS.PREP_EFFICACY);

  // Ajuste por prevalencia del tercero (si no es 100% seguro que es positivo)
  // Riesgo real = Riesgo_si_positivo * Prob_que_sea_positivo
  let pAcqPerAct = rAcqAvg * prevalence;

  // 2. Probabilidad de que ÉL se infecte en UN MES completo (suponiendo que empieza sano)
  let pInfectedMonth = probAtLeastOne(pAcqPerAct, actsThird);

  // --- SIMULACIÓN MES A MES ---
  
  // Estado inicial de Él:
  // Asumimos que empieza Sano (S=1). 
  // (Si quisieras "pInit", se restaría aquí, pero el usuario pidió verificar cálculos de flujo).
  let S = 1.0; // Probabilidad de ser Susceptible (Sano)
  
  // Arrays para gráfica
  let dataRiskMonthly = [];
  let dataRiskCum = [];
  let currentSafety = 1.0; // Probabilidad de que TÚ sigas sano

  // Variable para tracking de infección aguda
  // Como es probabilístico, rastreamos "proporción de la población de parejas" en cada estadio.
  // Estados: S (sano), I_acute1 (mes 1 de infección), I_acute2 (mes 2), I_chronic (crónico)
  let state = {
    S: 1.0,
    I_Eclipse: 0.0, // Infectado este mes, pero en ventana (no contagia)
    I_Acute1: 0.0,  // Infectado el mes pasado (muy contagioso)
    I_Acute2: 0.0,  // Infectado hace 2 meses (muy contagioso)
    I_Chronic: 0.0  // Infectado hace >2 meses (contagioso normal)
  };

  for (let m = 0; m < months; m++) {
    // A. ÉL tiene sexo con TERCERO y se puede infectar.
    // Los que eran S, ahora una parte pasa a I_Eclipse.
    let newInfections = state.S * pInfectedMonth;
    
    // B. TÚ tienes sexo con ÉL. ¿Cuál es el riesgo?
    // Riesgo viene de los grupos: I_Acute1, I_Acute2, I_Chronic, y PARTE de I_Eclipse (dependiendo del orden).

    // B1. Riesgo base hacia ti (Receptivo)
    let rTxBase = CONSTANTS.RISK_RECEPTIVE; 
    // Nota: Asumimos que con tu pareja NO usas condón (escenario típico de "pareja"), 
    // o está implícito en el número de actos "c". Si quisieras condón contigo, se aplicaría aquí.

    // B2. Calculamos probabilidad de transmisión SEGÚN ESTADIO viral de Él:
    
    // - Crónico:
    let pTxChronic = probAtLeastOne(rTxBase, actsYou);
    
    // - Agudo (x12):
    let rTxAcute = useAcute ? Math.min(1, rTxBase * CONSTANTS.ACUTE_MULTIPLIER) : rTxBase;
    let pTxAcute = probAtLeastOne(rTxAcute, actsYou);

    // - Eclipse (El mes actual):
    // Aquí es donde importa el "Eclipse Period" y el "Order".
    // Si se infectó este mes, los primeros ~10 días (0.33 del mes) NO contagia.
    // Además, depende de si tus actos fueron antes o después.
    // Factor de coincidencia: ¿Qué prob hay de que tus actos ocurran CUANDO él ya es contagioso?
    
    let exposureFactor = 0;
    if (actsThird > 0 && actsYou > 0) {
        // Lógica simplificada de solapamiento temporal
        // Si es "Random": Asumimos distribución uniforme. El riesgo es aprox la mitad del tiempo efectivo post-eclipse.
        // Si es "Worst": Él se infecta al principio, pasa eclipse, y luego te da a ti.
        
        let infectiousWindow = 1.0 - CONSTANTS.ECLIPSE_FRACTION; // Tiempo restante del mes tras eclipse (ej. 20 días)
        if (infectiousWindow < 0) infectiousWindow = 0;

        if (orderMode === 'worst') {
            exposureFactor = infectiousWindow; // Casi todo el riesgo posible
        } else {
            exposureFactor = infectiousWindow * 0.5; // Promedio estadístico
        }
    }
    
    // Riesgo del grupo "Recién infectado este mes":
    // Usamos la tasa Aguda porque la viremia sube rápido tras el eclipse.
    let pTxNew = probAtLeastOne(rTxAcute * exposureFactor, actsYou); 

    // C. Riesgo TOTAL para TI en el mes M
    // Es la suma ponderada de riesgos provenientes de cada sub-población de Él
    let riskFromChronic = state.I_Chronic * pTxChronic;
    let riskFromAcute1  = state.I_Acute1 * pTxAcute;
    let riskFromAcute2  = state.I_Acute2 * pTxAcute;
    let riskFromNew     = newInfections * pTxNew; // Los que se acaban de infectar
    
    // Como son eventos mutuamente excluyentes (él está en un solo estado), se suman las probabilidades ponderadas
    // (Aproximación válida para p < 0.1)
    let probInfectionYouMonth = riskFromChronic + riskFromAcute1 + riskFromAcute2 + riskFromNew;
    
    // Guardamos datos
    dataRiskMonthly.push(probInfectionYouMonth);
    currentSafety *= (1 - probInfectionYouMonth);
    dataRiskCum.push(1 - currentSafety);

    // D. AVANZAR ESTADOS de Él para el mes siguiente
    state.I_Chronic += state.I_Acute2; // Los de Acute2 pasan a Crónico
    state.I_Acute2 = state.I_Acute1;   // Los de Acute1 pasan a Acute2
    state.I_Acute1 = newInfections;    // Los nuevos (que eran Eclipse) pasan a Acute1 (mes completo agudo)
    state.S = state.S - newInfections; // Los sanos disminuyen
  }

  // Resultados finales
  let finalRisk = 1 - currentSafety;
  let avgMonthly = dataRiskMonthly.reduce((a,b)=>a+b,0) / months;

  ui.rMonth.innerText = fmtPct(avgMonthly);
  ui.rMonthN.innerText = fmtOneIn(avgMonthly);
  
  ui.rTotal.innerText = fmtPct(finalRisk);
  ui.rTotalN.innerText = fmtOneIn(finalRisk);

  let coins = finalRisk > 0 ? -Math.log2(finalRisk).toFixed(1) : "Inf";
  ui.rCoin.innerText = coins;

  drawChart(dataRiskCum);
}

function drawChart(data) {
  const w = ctx.canvas.width;
  const h = ctx.canvas.height;
  ctx.clearRect(0,0,w,h);
  
  // Config
  const pad = 40;
  const gw = w - pad*2;
  const gh = h - pad*2;
  
  const maxVal = Math.max(0.01, ...data); // Minimo 1% escala
  const yScale = gh / (maxVal * 1.1);
  const xScale = gw / (data.length - 1);

  // Grid
  ctx.strokeStyle = "#333";
  ctx.lineWidth = 1;
  ctx.beginPath();
  // Eje Y (0, 50%, 100% relative to max)
  ctx.moveTo(pad, h-pad); ctx.lineTo(w-pad, h-pad);
  ctx.stroke();

  // Línea
  ctx.strokeStyle = "#ff4fa3"; // Accent
  ctx.lineWidth = 3;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.beginPath();
  
  // Sombra (Fill)
  ctx.fillStyle = "rgba(255, 79, 163, 0.1)";
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  
  data.forEach((p, i) => {
    const x = pad + i * xScale;
    const y = (h - pad) - (p * yScale);
    ctx.lineTo(x, y);
  });
  
  ctx.lineTo(pad + (data.length-1)*xScale, h-pad);
  ctx.fill();

  // Trazo
  ctx.beginPath();
  data.forEach((p, i) => {
    const x = pad + i * xScale;
    const y = (h - pad) - (p * yScale);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Texto max
  ctx.fillStyle = "#fff";
  ctx.font = "12px monospace";
  ctx.fillText((maxVal*1.1*100).toFixed(1) + "%", 5, 20);
  ctx.fillText("0%", 10, h-pad);
  
  // Meses
  ctx.fillText("Mes 1", pad, h-10);
  ctx.fillText("Mes "+data.length, w-pad-20, h-10);
}

// Listeners
Object.values(ui).forEach(el => {
  if(el instanceof HTMLElement) el.addEventListener('input', update);
});

function update() {
  ui.gVal.innerText = ui.g.value;
  ui.cVal.innerText = ui.c.value;
  ui.mVal.innerText = ui.m.value;
  ui.pPrevVal.innerText = ui.prev.value + '%';
  ui.condomVal.innerText = ui.condom.value + '%';
  calculate();
}

// Init
update();

</script>
</body>
</html>
