<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riesgo encadenado — Interactivo (estado multi-mes + rosa)</title>
<style>
  :root {
    --bg:#1b0b16;
    --panel:#2a0f22;
    --text:#ffe9f4;
    --accent:#ff4fa3;
    --accent2:#ffc1dd;
  }
  * { box-sizing: border-box; }
  body { margin:0; padding:24px; background:linear-gradient(180deg, #180814, #2b0f23 40%, #3a1530);
         font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; color:var(--text); }
  .wrap { max-width: 1200px; margin:0 auto; }
  h1 { font-weight:800; margin:0 0 12px; color:#ffd7ec; }
  p { opacity:.92; }
  .grid { display:grid; grid-template-columns: 1.1fr 1fr; gap:16px; }
  .card { background:var(--panel); border:1px solid rgba(255,255,255,.12);
          border-radius:16px; padding:16px; box-shadow:0 14px 36px rgba(0,0,0,.35); }
  label { font-size:13px; opacity:.9; display:block; margin-bottom:6px; }
  input[type="range"] { width:100%; accent-color: var(--accent); }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .val { font-weight:800; color:var(--accent); min-width:64px; text-align:right; }
  select, input[type="checkbox"] { padding:8px; border-radius:10px; background:#351029; color:var(--text);
    border:1px solid rgba(255,255,255,.18); }
  .stats { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px; }
  .stat { background:#351029; border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px; }
  .stat h3 { margin:0 0 8px; font-size:13px; opacity:.85; font-weight:700; color:#ffd7ec; }
  .stat .big { font-size:20px; font-weight:900; color:#fff; }
  canvas { width:100%; height:420px; background:#1f0b19; border-radius:14px; border:1px solid rgba(255,255,255,.12); }
  .foot { opacity:.8; font-size:12px; margin-top:10px; color:#ffd7ec; }
  @media (max-width: 1100px) { .grid { grid-template-columns:1fr; } }
  .pgrid { max-height: 280px; overflow:auto; border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px; background:#351029; }
  .prow { display:grid; grid-template-columns: 120px 1fr 80px; align-items:center; gap:10px; margin:6px 0; }
  .pval { text-align:right; color:#fff; font-weight:800; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Riesgo encadenado (anal): simulador mensual</h1>
  <p>Ahora el modo <strong>Mejor</strong> no queda en cero: el modelo <strong>lleva estado entre meses</strong>. Si él se infecta
     <em>después</em> de verte en un mes, puede transmitirte en meses siguientes. Paleta rosa, eje Y con zoom.</p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label>Veces que te engaña al mes (cuando hay infidelidad)</label>
          <input id="g" type="range" min="0" max="20" step="1" value="4" />
        </div>
        <div class="val"><span id="gVal">4</span>×</div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Veces que tiene relaciones contigo al mes</label>
          <input id="c" type="range" min="0" max="20" step="1" value="1" />
        </div>
        <div class="val"><span id="cVal">1</span>×</div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Horizonte (meses)</label>
          <input id="months" type="range" min="1" max="240" step="1" value="24" />
        </div>
        <div class="val"><span id="mVal">24</span></div>
      </div>
      <div class="row">
        <div>
          <label>Orden dentro del mes</label>
          <select id="mode">
            <option value="best">Mejor (tus actos antes que todos los del tercero)</option>
            <option value="random" selected>Aleatorio (mitad antes / mitad después aprox.)</option>
            <option value="worst">Peor (tus actos después de todos los del tercero)</option>
          </select>
        </div>
        <div>
          <label><input id="acute" type="checkbox" /> Fase aguda ×7 (cota superior en pareja→tú)</label>
        </div>
      </div>

      <!-- Nuevo: prob. inicial de que tu pareja ya esté infectada -->
      <div class="row">
        <div style="flex:1">
          <label>Prob. inicial de que tu pareja <strong>ya esté infectada</strong> (mes 0)</label>
          <input id="pInit" type="range" min="0" max="100" step="1" value="0" />
        </div>
        <div class="val"><span id="pInitVal">0</span>%</div>
      </div>

      <!-- Prob transmisible 3ª persona -->
      <div class="row">
        <div style="flex:1">
          <label>Prob. de que la 3ª persona sea <strong>transmisible</strong> (no suprimida)</label>
          <input id="pTx" type="range" min="0" max="100" step="1" value="100" />
        </div>
        <div class="val"><span id="pTxVal">100</span>%</div>
      </div>

      <!-- Condón con 3ª persona -->
      <div class="row" style="margin-top:6px">
        <label><input id="enableCondomTotal" type="checkbox" /> Usar <strong>prob. de condón TOTAL</strong> (3ª persona)</label>
      </div>
      <div class="row" id="condomTotalRow" style="display:none">
        <div style="flex:1">
          <label>Prob. de condón TOTAL con la 3ª persona</label>
          <input id="pCondomTotal" type="range" min="0" max="100" step="1" value="50" />
        </div>
        <div class="val"><span id="pCondomTotalVal">50</span>%</div>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input id="enableCondomPerMonth" type="checkbox" /> Usar <strong>prob. de condón por mes</strong> (3ª persona)</label>
      </div>
      <div class="pgrid" id="pgridCondom" style="display:none"></div>
      <div class="foot">Eficacia de condón asumida: 80% (reduce 80% el riesgo por acto). Si activas ambas, q<sub>m</sub> = q<sub>TOTAL</sub>×q<sub>mes,m</sub>.</div>

      <!-- Prob. total/por-mes de infidelidad -->
      <div class="row" style="margin-top:12px">
        <label><input id="enableTotal" type="checkbox" checked /> Usar <strong>prob. de infidelidad TOTAL</strong></label>
      </div>
      <div class="row" id="totalRow">
        <div style="flex:1">
          <label>Prob. infidelidad TOTAL (misma todos los meses)</label>
          <input id="pTotal" type="range" min="0" max="100" step="1" value="30" />
        </div>
        <div class="val"><span id="pTotalVal">30</span>%</div>
      </div>
      <div class="row" style="margin-top:6px">
        <label><input id="enablePerMonth" type="checkbox" /> Usar <strong>prob. de infidelidad por mes</strong></label>
      </div>
      <div class="pgrid" id="pgrid" style="display:none"></div>
      <div class="foot">Si activas ambas: pInf<sub>m</sub> = pTOTAL × pMES<sub>m</sub>. Si ambas off, pInf<sub>m</sub>=1.</div>

      <div class="stats">
        <div class="stat">
          <h3>p mensual (promedio)</h3>
          <div class="big" id="pMonth">—</div>
          <div class="foot" id="pMonthN">1 en N: —</div>
        </div>
        <div class="stat">
          <h3>Acumulada en horizonte</h3>
          <div class="big" id="pCum">—</div>
          <div class="foot" id="pCumN">1 en N: —</div>
        </div>
        <div class="stat">
          <h3>Equiv. moneda</h3>
          <div class="big" id="coinEq">—</div>
          <div class="foot">k tal que (1/2)^k ≈ p_prom</div>
        </div>
      </div>
    </div>

    <div class="card">
      <canvas id="chart"></canvas>
      <div class="foot">Ahora la curva se calcula con estado: S<sub>m</sub> y I<sub>m</sub> (susceptible/infectado). Si se infecta
      en el mes m (aunque sea después de verte), eso afecta el mes m+1.</div>
    </div>
  </div>
</div>

<script>
(function(){
  const rTopBase = 0.0011;  // él insertivo con 3ª persona bottom
  const rBottom  = 0.0138;  // transmisión hacia ti (tú bottom)
  const condomEff = 0.80;   // eficacia
  const MAX_PMES = 60;

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // Riesgo de adquisición frente a la 3ª persona para j actos "antes de verte" y g actos totales en el mes
  function pAcquireBefore(j, g, fTx, qCondom){
    // rTop ajustado por transmisible y condón
    const r_nc = clamp01(rTopBase * fTx);          // sin condón
    const r_wc = clamp01(r_nc * (1 - condomEff));  // con condón
    const noInf_before = Math.pow(1 - r_nc, j*(1 - qCondom)) * Math.pow(1 - r_wc, j*qCondom);
    return 1 - noInf_before;
  }

  function pAcquireFull(g, fTx, qCondom){
    const r_nc = clamp01(rTopBase * fTx);
    const r_wc = clamp01(r_nc * (1 - condomEff));
    const noInf_full = Math.pow(1 - r_nc, g*(1 - qCondom)) * Math.pow(1 - r_wc, g*qCondom);
    return 1 - noInf_full;
  }

  function pTransmitToYou(c, acute){
    const mult = acute ? 7.0 : 1.0;
    const r2 = clamp01(rBottom * mult);
    return 1 - Math.pow(1 - r2, c);
  }

  // Ticks "nice"
  function niceStep(step){
    const exp = Math.floor(Math.log10(step));
    const f = step / Math.pow(10, exp);
    let nf;
    if (f <= 1) nf = 1;
    else if (f <= 2) nf = 2;
    else if (f <= 2.5) nf = 2.5;
    else if (f <= 5) nf = 5;
    else nf = 10;
    return nf * Math.pow(10, exp);
  }

  // UI refs
  const gEl = document.getElementById("g");
  const cEl = document.getElementById("c");
  const mEl = document.getElementById("months");
  const modeEl = document.getElementById("mode");
  const acuteEl = document.getElementById("acute");
  const pInitEl = document.getElementById("pInit");
  const pInitValEl = document.getElementById("pInitVal");
  const pTxEl = document.getElementById("pTx");
  const pTxValEl = document.getElementById("pTxVal");

  const enableCondomTotalEl = document.getElementById("enableCondomTotal");
  const pCondomTotalEl = document.getElementById("pCondomTotal");
  const pCondomTotalValEl = document.getElementById("pCondomTotalVal");
  const condomTotalRow = document.getElementById("condomTotalRow");
  const enableCondomPerMonthEl = document.getElementById("enableCondomPerMonth");
  const pgridCondom = document.getElementById("pgridCondom");

  const enableTotalEl = document.getElementById("enableTotal");
  const pTotalEl = document.getElementById("pTotal");
  const pTotalValEl = document.getElementById("pTotalVal");
  const totalRow = document.getElementById("totalRow");
  const enablePerMonthEl = document.getElementById("enablePerMonth");
  const pgrid = document.getElementById("pgrid");

  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");

  const pMonthEl = document.getElementById("pMonth");
  const pMonthNEl = document.getElementById("pMonthN");
  const pCumEl = document.getElementById("pCum");
  const pCumNEl = document.getElementById("pCumN");
  const coinEqEl = document.getElementById("coinEq");

  function buildPGrid(container, months, labelPrefix, defaultVal){
    container.innerHTML = "";
    const M = Math.min(months, MAX_PMES);
    for (let i=1;i<=M;i++){
      const row = document.createElement("div");
      row.className = "prow";
      const lab = document.createElement("div");
      lab.textContent = labelPrefix + " " + i;
      const rng = document.createElement("input");
      rng.type = "range"; rng.min = "0"; rng.max = "100"; rng.step = "1"; rng.value = String(defaultVal);
      rng.dataset.index = (i-1).toString();
      const out = document.createElement("div");
      out.className = "pval"; out.textContent = defaultVal + "%";
      rng.addEventListener("input", () => { out.textContent = rng.value + "%"; update(); });
      row.appendChild(lab); row.appendChild(rng); row.appendChild(out);
      container.appendChild(row);
    }
  }

  function arrayFromGrid(container, months, base){
    const M = months;
    const arr = Array(M).fill(base);
    const sliders = container.querySelectorAll('input[type="range"]');
    const vals = Array.from(sliders).map(r => parseInt(r.value,10)/100);
    for (let i=0;i<M;i++){
      const v = (i < vals.length) ? vals[i] : (vals.length ? vals[vals.length-1] : 1.0);
      arr[i] *= v;
    }
    return arr;
  }

  function getPInfArr(months){
    const base = enableTotalEl.checked ? parseInt(pTotalEl.value,10)/100 : 1.0;
    if (enablePerMonthEl.checked) return arrayFromGrid(pgrid, months, base);
    return Array(months).fill(base);
  }

  function getQCondomArr(months){
    const base = enableCondomTotalEl.checked ? parseInt(pCondomTotalEl.value,10)/100 : 0.0;
    if (enableCondomPerMonthEl.checked) return arrayFromGrid(pgridCondom, months, base);
    return Array(months).fill(base);
  }

  function computeYAxisMax(cumArray){
    let maxPct = 0;
    for (let i=0;i<cumArray.length;i++) maxPct = Math.max(maxPct, cumArray[i]*100);
    const minCap = 0.1;
    maxPct = Math.max(maxPct*1.1, minCap);
    const rawStep = maxPct / 5;
    const step = niceStep(rawStep);
    const yMax = step * 5;
    return {yMax, step};
  }

  function formatPct(x){
    if (!isFinite(x)) return "—";
    if (x === 0) return "0%";
    const pct = x*100;
    if (pct >= 1) return pct.toFixed(3) + "%";
    if (pct >= 0.1) return pct.toFixed(4) + "%";
    if (pct >= 0.01) return pct.toFixed(5) + "%";
    return pct.toExponential(2).replace("e-","×10^-") + "%";
  }
  function oneInN(x){ return x <= 0 ? "—" : ("1 / " + Math.round(1/x).toLocaleString()); }
  function coinK(p){ return p <= 0 ? "—" : ((-Math.log(p)/Math.log(2)).toFixed(2) + " caras"); }

  function drawCurve(cumArray){
    const W = canvas.clientWidth, H = canvas.clientHeight;
    canvas.width = W*2; canvas.height = H*2; ctx.setTransform(1,0,0,1,0,0); ctx.scale(2,2);
    ctx.clearRect(0,0,W,H);

    const M = cumArray.length - 1;
    const {yMax, step} = computeYAxisMax(cumArray);

    // Ejes
    ctx.strokeStyle = "rgba(255,193,221,.25)";
    ctx.lineWidth = 1;
    ctx.fillStyle = "rgba(255,217,235,.9)";
    ctx.font = "12px system-ui";
    for(let i=0;i<=5;i++){
      const yVal = i*step;
      const y = H - (H-36)*(yVal / yMax) - 8;
      ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-10,y); ctx.stroke();
      let label;
      if (yMax >= 10) label = yVal.toFixed(1) + "%";
      else if (yMax >= 1) label = yVal.toFixed(2) + "%";
      else if (yMax >= 0.1) label = yVal.toFixed(3) + "%";
      else label = yVal.toExponential(2).replace("e-","×10^-") + "%";
      ctx.fillText(label, 6, y+4);
    }
    const steps = Math.min(10, Math.ceil(M/24));
    for(let i=0;i<=steps;i++){
      const mTick = Math.round(i*M/steps);
      const x = 40 + (W-60)*(mTick/M);
      ctx.beginPath(); ctx.moveTo(x, H-28); ctx.lineTo(x, H-24); ctx.stroke();
      ctx.fillText(mTick.toString(), x-8, H-6);
    }

    // Curva
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    ctx.lineWidth = 2.6;
    ctx.beginPath();
    for(let m=0; m<=M; m++){
      const yPct = cumArray[m]*100;
      const x = 40 + (W-60)*(m/M);
      const y = H - (H-36)*(yPct / yMax) - 8;
      if(m===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  function update(){
    const g = parseInt(gEl.value,10);
    const c = parseInt(cEl.value,10);
    const months = parseInt(mEl.value,10);
    const mode = modeEl.value;
    const acute = acuteEl.checked;
    const fTx = parseInt(pTxEl.value,10)/100;
    const pInit = parseInt(pInitEl.value,10)/100;

    // UI text
    document.getElementById("gVal").textContent = g;
    document.getElementById("cVal").textContent = c;
    document.getElementById("mVal").textContent = months;
    pTxValEl.textContent = pTxEl.value;
    pTotalValEl.textContent = pTotalEl.value;
    pCondomTotalValEl.textContent = pCondomTotalEl.value;
    pInitValEl.textContent = pInitEl.value;
    condomTotalRow.style.display = enableCondomTotalEl.checked ? "flex" : "none";
    totalRow.style.display = enableTotalEl.checked ? "flex" : "none";

    // Arrays por mes
    const pInfArr = getPInfArr(months);
    const qCondomArr = getQCondomArr(months);

    // Simulación con estado: S=prob susceptible al inicio del mes; I=1-S
    let S = 1 - pInit;
    // pUser_m: prob de infectarte en el mes m (condicional a que tú sigues sana/o)
    const pUserArr = [];
    const cumArray = [0];
    let prodSafe = 1;

    for (let m=0; m<months; m++){
      const pInf = pInfArr[m];
      const qC = qCondomArr[m];

      // j_before según modo
      let j_before = 0;
      if (mode === "random") j_before = g/2;
      else if (mode === "worst") j_before = g;
      // Mejor = 0 (todos tus actos antes de los del tercero)

      const pBefore = pInf * pAcquireBefore(j_before, g, fTx, qC);
      const pFull   = pInf * pAcquireFull(g, fTx, qC);
      const pToYou  = pTransmitToYou(c, acute);

      // Prob. de contagiarte este mes:
      // - si él ya venía infectado (1-S): (1-S) * pToYou
      // - si él era susceptible (S) pero se infecta antes de tus actos: S * pBefore * pToYou
      const pMonthYou = (1 - S) * pToYou + S * pBefore * pToYou;

      pUserArr.push(pMonthYou);

      // Actualizar acumulada para ti (1 - ∏(1 - pMonthYou))
      prodSafe *= (1 - pMonthYou);
      cumArray.push(1 - prodSafe);

      // Evolución del estado de él al final del mes:
      // Si era susceptible, puede infectarse en algún momento del mes con prob pFull.
      S = S * (1 - pFull);
    }

    // Estadísticas
    const pAvg = pUserArr.reduce((a,b)=>a+b,0) / Math.max(1, pUserArr.length);
    pMonthEl.textContent = formatPct(pAvg);
    pMonthNEl.textContent = "1 en N: " + oneInN(pAvg);
    const pCum = cumArray[cumArray.length-1];
    pCumEl.textContent = formatPct(pCum);
    pCumNEl.textContent = "1 en N: " + oneInN(pCum);
    coinEqEl.textContent = coinK(pAvg);

    drawCurve(cumArray);
  }

  // Bind
  [
    gEl,cEl,mEl,modeEl,acuteEl,pTxEl,pInitEl,
    enableCondomTotalEl,pCondomTotalEl,enableCondomPerMonthEl,
    enableTotalEl,pTotalEl,enablePerMonthEl
  ].forEach(el => el.addEventListener("input", () => {
    if (el === enablePerMonthEl){
      const show = enablePerMonthEl.checked;
      pgrid.style.display = show ? "block" : "none";
      if (show) buildPGrid(pgrid, parseInt(mEl.value,10), "Mes", 30);
    }
    if (el === enableCondomPerMonthEl){
      const show = enableCondomPerMonthEl.checked;
      pgridCondom.style.display = show ? "block" : "none";
      if (show) buildPGrid(pgridCondom, parseInt(mEl.value,10), "Mes (condón)", 50);
    }
    if (el === mEl){
      if (enablePerMonthEl.checked) buildPGrid(pgrid, parseInt(mEl.value,10), "Mes", 30);
      if (enableCondomPerMonthEl.checked) buildPGrid(pgridCondom, parseInt(mEl.value,10), "Mes (condón)", 50);
    }
    update();
  }));

  // Init grids
  buildPGrid(pgrid, parseInt(mEl.value,10), "Mes", 30);
  buildPGrid(pgridCondom, parseInt(mEl.value,10), "Mes (condón)", 50);
  update();
})();
</script>
</body>
</html>
